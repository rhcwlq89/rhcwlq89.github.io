---
title: "ìŠ¤í”„ë§ë¶€íŠ¸ ì‹¤ë¬´ ê°€ì´ë“œ 3í¸: ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜"
description: "Kafkaì™€ Outbox íŒ¨í„´ìœ¼ë¡œ ì‹ ë¢°ì„± ìˆëŠ” ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¶•í•˜ê¸°"
pubDate: 2026-01-25T12:00:00
tags: ["Spring Boot", "Kafka", "Event-Driven", "Backend", "ì‹¤ë¬´ê°€ì´ë“œ"]
heroImage: "../../assets/PracticalGuideSeries.png"
---

## ì‹œë¦¬ì¦ˆ ë„¤ë¹„ê²Œì´ì…˜

| ì´ì „ | í˜„ì¬ | ë‹¤ìŒ |
|:---:|:---:|:---:|
| [2í¸: ìºì‹± ì „ëµ](/blog/springboot-practical-guide-2) | **3í¸: ì´ë²¤íŠ¸ ë“œë¦¬ë¸** | [4í¸: Resilience íŒ¨í„´](/blog/springboot-practical-guide-4) |

---

## ì„œë¡ 

ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì€ ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ê³¼ ì•ˆì •ì„±ì„ ì¢Œìš°í•œë‹¤. ë™ê¸° ë°©ì‹ì˜ ì§ì ‘ í˜¸ì¶œì€ ê°•í•œ ê²°í•©ê³¼ ì¥ì•  ì „íŒŒ ë¬¸ì œë¥¼ ì•¼ê¸°í•˜ë©°, ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜**ê°€ ë„ë¦¬ ì‚¬ìš©ëœë‹¤.

**3í¸ì—ì„œ ë‹¤ë£¨ëŠ” ë‚´ìš©:**
- ë™ê¸° ë°©ì‹ì˜ í•œê³„ì™€ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ì˜ ì¥ì 
- ë©”ì‹œì§€ íì˜ ì—­í• ê³¼ Kafka ê¸°ë³¸ ê°œë…
- Outbox íŒ¨í„´ìœ¼ë¡œ ì´ë²¤íŠ¸ ë°œí–‰ ì‹ ë¢°ì„± í™•ë³´
- Consumer ë©±ë“±ì„± êµ¬í˜„ ì „ëµ

### ëª©ì°¨

- [ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ (EDA)](#1-ì´ë²¤íŠ¸-ë“œë¦¬ë¸-ì•„í‚¤í…ì²˜-eda)
- [ë©”ì‹œì§€ í](#2-ë©”ì‹œì§€-í)
- [ì´ë²¤íŠ¸ ì„¤ê³„](#3-ì´ë²¤íŠ¸-ì„¤ê³„)
- [ì´ë²¤íŠ¸ ë°œí–‰ì˜ ì‹ ë¢°ì„± ë¬¸ì œ](#4-ì´ë²¤íŠ¸-ë°œí–‰ì˜-ì‹ ë¢°ì„±-ë¬¸ì œ)
- [Outbox íŒ¨í„´ êµ¬í˜„](#5-outbox-íŒ¨í„´-êµ¬í˜„)
- [ì¤‘ë³µ ë°œí–‰ê³¼ ë©±ë“±ì„±](#6-ì¤‘ë³µ-ë°œí–‰ê³¼-ë©±ë“±ì„±)
- [Kafka ê¸°ë³¸ ê°œë…](#7-kafka-ê¸°ë³¸-ê°œë…)
- [Kafka ì„¤ì •](#8-kafka-ì„¤ì •)
- [ì „ì²´ íë¦„ ìš”ì•½](#9-ì „ì²´-íë¦„-ìš”ì•½)
- [FAQ](#10-faq-ë©´ì ‘-ëŒ€ë¹„)
- [ì •ë¦¬](#ì •ë¦¬)

---

## 1. ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ (EDA)

### 1.1 ì „í†µì ì¸ ë™ê¸° ë°©ì‹ì˜ í•œê³„

**ì§ì ‘ í˜¸ì¶œ ë°©ì‹ (Request-Response)**

```
ì£¼ë¬¸ ì„œë¹„ìŠ¤ê°€ ëª¨ë“  í›„ì† ì‘ì—…ì„ ì§ì ‘ í˜¸ì¶œ:

[OrderService]
     â”‚
     â”œâ”€â”€â–¶ [InventoryService].decreaseStock()    (50ms)
     â”œâ”€â”€â–¶ [PaymentService].processPayment()     (200ms)
     â”œâ”€â”€â–¶ [EmailService].sendConfirmation()     (500ms)
     â”œâ”€â”€â–¶ [NotificationService].sendPush()      (300ms)
     â””â”€â”€â–¶ [AnalyticsService].recordOrder()      (100ms)

ì´ ì‘ë‹µ ì‹œê°„: 1,150ms
```

**ë¬¸ì œì :**

| ë¬¸ì œ | ì„¤ëª… |
|------|------|
| **ê°•í•œ ê²°í•©** | OrderServiceê°€ 5ê°œ ì„œë¹„ìŠ¤ì— ì˜ì¡´ |
| **ê¸´ ì‘ë‹µ ì‹œê°„** | ëª¨ë“  ì‘ì—…ì´ ëë‚˜ì•¼ ì‘ë‹µ |
| **ì¥ì•  ì „íŒŒ** | EmailService ì¥ì•  â†’ ì£¼ë¬¸ ì‹¤íŒ¨ |
| **í™•ì¥ ì–´ë ¤ì›€** | ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ OrderService ìˆ˜ì • í•„ìš” |

### 1.2 ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ë°©ì‹

**"ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚¬ë‹¤"ë¥¼ ì•Œë¦¬ê³ , ê´€ì‹¬ ìˆëŠ” ì„œë¹„ìŠ¤ê°€ ë°˜ì‘**

```
[OrderService]
     â”‚
     â””â”€â”€â–¶ "ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆë‹¤" (ì´ë²¤íŠ¸ ë°œí–‰)
              â”‚
              â”œâ”€â”€â–¶ [InventoryService] "ì¬ê³  ì°¨ê°í• ê²Œ"
              â”œâ”€â”€â–¶ [PaymentService] "ê²°ì œ ì²˜ë¦¬í• ê²Œ"
              â”œâ”€â”€â–¶ [EmailService] "ì´ë©”ì¼ ë³´ë‚¼ê²Œ"
              â”œâ”€â”€â–¶ [NotificationService] "í‘¸ì‹œ ë³´ë‚¼ê²Œ"
              â””â”€â”€â–¶ [AnalyticsService] "ê¸°ë¡í• ê²Œ"

OrderService ì‘ë‹µ ì‹œê°„: 50ms (ì´ë²¤íŠ¸ ë°œí–‰ë§Œ)
ë‚˜ë¨¸ì§€ëŠ” ë¹„ë™ê¸°ë¡œ ê°ì ì²˜ë¦¬
```

### 1.3 í•µì‹¬ ê°œë…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜                         â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ Producer  â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  Message  â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚ Consumer  â”‚    â”‚
â”‚   â”‚ (ë°œí–‰ì)   â”‚  Event  â”‚   Queue   â”‚  Event  â”‚ (ì†Œë¹„ì)   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  (ë¸Œë¡œì»¤)  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚        â”‚                      â”‚                      â”‚          â”‚
â”‚   "ì¼ì´ ì¼ì–´ë‚¬ë‹¤"         ë©”ì‹œì§€ ì €ì¥/ì „ë‹¬        "ë‚´ê°€ ì²˜ë¦¬í• ê²Œ"   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ìš©ì–´ | ì„¤ëª… | í”„ë¡œì íŠ¸ ì˜ˆì‹œ |
|------|------|--------------|
| **Event** | ì‹œìŠ¤í…œì—ì„œ ë°œìƒí•œ ì‚¬ì‹¤ | "ì£¼ë¬¸ì´ ìƒì„±ë¨" |
| **Producer** | ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ëŠ” ì„œë¹„ìŠ¤ | OrderService |
| **Consumer** | ì´ë²¤íŠ¸ë¥¼ ì†Œë¹„í•˜ëŠ” ì„œë¹„ìŠ¤ | EmailService |
| **Message Queue** | ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•˜ê³  ì „ë‹¬ | Kafka |

---

## 2. ë©”ì‹œì§€ í

### 2.1 ë©”ì‹œì§€ íë€?

**ë¹„ìœ : ìš°ì²´êµ­ ì‹œìŠ¤í…œ**

```
[ë™ê¸° ë°©ì‹] - ì§ì ‘ ì „ë‹¬
ë°œì‹ ì â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ìˆ˜ì‹ ì
       ë°œì‹ ìê°€ ìˆ˜ì‹ ì ì§‘ê¹Œì§€ ê°€ì„œ
       ì§ì ‘ ì „ë‹¬ (ìˆ˜ì‹ ì ì—†ìœ¼ë©´ ëŒ€ê¸°)

[ë©”ì‹œì§€ í] - ìš°ì²´êµ­ ê²½ìœ 
ë°œì‹ ì â”€â”€â–¶ [ìš°ì²´êµ­] â”€â”€â–¶ ìˆ˜ì‹ ì
           â”‚
           â”œâ”€â”€ ë©”ì‹œì§€ ë³´ê´€
           â”œâ”€â”€ ìˆ˜ì‹ ì ë¶€ì¬ ì‹œ ë³´ê´€
           â””â”€â”€ ìˆ˜ì‹ ìê°€ ì›í•  ë•Œ ìˆ˜ë ¹
```

### 2.2 ë©”ì‹œì§€ íì˜ ì¥ì 

| ì¥ì  | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **ë¹„ë™ê¸° ì²˜ë¦¬** | ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ | ì£¼ë¬¸ í›„ ì¦‰ì‹œ ì‘ë‹µ, ì´ë©”ì¼ì€ ë‚˜ì¤‘ì— |
| **ë””ì»¤í”Œë§** | ì„œë¹„ìŠ¤ ê°„ ì§ì ‘ ì˜ì¡´ ì œê±° | OrderServiceëŠ” EmailService ëª°ë¼ë„ ë¨ |
| **ë²„í¼ë§** | íŠ¸ë˜í”½ ê¸‰ì¦ ì‹œ ì™„ì¶© | ì´ˆë‹¹ 1000ê±´ â†’ íì— ìŒ“ê³  ì²œì²œíˆ ì²˜ë¦¬ |
| **ì‹ ë¢°ì„±** | ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€ | Consumer ì£½ì–´ë„ ë©”ì‹œì§€ ë³´ì¡´ |
| **í™•ì¥ì„±** | Consumer ìˆ˜í‰ í™•ì¥ | ì²˜ë¦¬ ëŠë¦¬ë©´ Consumer ì¶”ê°€ |

### 2.3 ë©”ì‹œì§€ í ì¢…ë¥˜

| ì¢…ë¥˜ | íŠ¹ì§• | ì‚¬ìš© ì‚¬ë¡€ |
|------|------|----------|
| **Kafka** | ê³ ì„±ëŠ¥, ì˜êµ¬ ì €ì¥, ì¬ì²˜ë¦¬ ê°€ëŠ¥ | ëŒ€ìš©ëŸ‰ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° |
| **RabbitMQ** | ìœ ì—°í•œ ë¼ìš°íŒ…, ë‹¤ì–‘í•œ í”„ë¡œí† ì½œ | ë³µì¡í•œ ë¼ìš°íŒ… í•„ìš” ì‹œ |
| **AWS SQS** | ê´€ë¦¬í˜•, ê°„í¸í•œ ì„¤ì • | AWS í™˜ê²½ |
| **Redis Pub/Sub** | ì´ˆê²½ëŸ‰, ë©”ëª¨ë¦¬ ê¸°ë°˜ | ì‹¤ì‹œê°„ ì•Œë¦¼ (ë¹„ì˜êµ¬ì ) |

### 2.4 Point-to-Point vs Pub/Sub

**Point-to-Point (1:1)**
```
Producer â”€â”€â–¶ [Queue] â”€â”€â–¶ Consumer
              â”‚
              â””â”€â”€ í•˜ë‚˜ì˜ Consumerë§Œ ë©”ì‹œì§€ ìˆ˜ì‹ 
```

**Publish/Subscribe (1:N)** - Kafka ë°©ì‹
```
Producer â”€â”€â–¶ [Topic] â”€â”€â”¬â”€â”€â–¶ Consumer Group A
                       â”œâ”€â”€â–¶ Consumer Group B
                       â””â”€â”€â–¶ Consumer Group C

              â””â”€â”€ ëª¨ë“  ê·¸ë£¹ì´ ê°™ì€ ë©”ì‹œì§€ ìˆ˜ì‹ 
```

---

## 3. ì´ë²¤íŠ¸ ì„¤ê³„

### 3.1 ì¢‹ì€ ì´ë²¤íŠ¸ì˜ íŠ¹ì§•

**1. ê³¼ê±°í˜•ìœ¼ë¡œ ëª…ëª… (ì´ë¯¸ ì¼ì–´ë‚œ ì‚¬ì‹¤)**
```
ì¢‹ìŒ: OrderCreated, PaymentCompleted, ItemShipped
ë‚˜ì¨: CreateOrder, ProcessPayment, ShipItem
```

**2. ë¶ˆë³€ì„± (Immutable)**
```kotlin
// ì´ë²¤íŠ¸ëŠ” ë°œìƒí•œ ì‚¬ì‹¤ì´ë¯€ë¡œ ë³€ê²½ ë¶ˆê°€
data class OrderCreatedEvent(
    val orderId: Long,
    val buyerId: Long,
    val totalAmount: BigDecimal,
    val occurredAt: LocalDateTime = LocalDateTime.now()
)
```

**3. ìê¸° ì™„ê²°ì„± (Self-contained)**
```kotlin
// ë‚˜ì¨: Consumerê°€ ì¶”ê°€ ì¡°íšŒ í•„ìš”
data class OrderCreatedEvent(
    val orderId: Long  // ì´ê²ƒë§Œìœ¼ë¡  ì •ë³´ ë¶€ì¡±
)

// ì¢‹ìŒ: í•„ìš”í•œ ì •ë³´ í¬í•¨
data class OrderCreatedEvent(
    val orderId: Long,
    val orderNumber: String,
    val buyerId: Long,
    val buyerEmail: String,
    val items: List<OrderItemDto>,
    val totalAmount: BigDecimal
)
```

### 3.2 í”„ë¡œì íŠ¸ì˜ ì´ë²¤íŠ¸ ì˜ˆì‹œ

```kotlin
// ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸
payload = mapOf(
    "orderId" to savedOrder.id,
    "buyerId" to buyerId,
    "sellerIds" to sellerIds.toList(),
    "totalAmount" to savedOrder.totalAmount,
    "orderNumber" to savedOrder.orderNumber
)

// ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
payload = mapOf(
    "orderId" to savedOrder.id,
    "buyerId" to order.buyer.id,
    "sellerId" to sellerId,
    "status" to newStatus.name,
    "orderNumber" to savedOrder.orderNumber
)
```

---

## 4. ì´ë²¤íŠ¸ ë°œí–‰ì˜ ì‹ ë¢°ì„± ë¬¸ì œ

### 4.1 ì´ì¤‘ ì“°ê¸° ë¬¸ì œ (Dual Write Problem)

```kotlin
@Transactional
fun createOrder(request: CreateOrderRequest) {
    // 1. DBì— ì£¼ë¬¸ ì €ì¥
    val order = orderRepository.save(Order(...))

    // 2. ë©”ì‹œì§€ íì— ì´ë²¤íŠ¸ ë°œí–‰
    messageQueue.send(OrderCreatedEvent(order.id))  // â† ë¬¸ì œ!
}
```

**ì™œ ë¬¸ì œì¸ê°€?**

```
DBì™€ ë©”ì‹œì§€ íëŠ” ë³„ê°œì˜ ì‹œìŠ¤í…œ (ì„œë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜)

Case 1: DB ì»¤ë°‹ ì„±ê³µ, ë©”ì‹œì§€ ë°œí–‰ ì‹¤íŒ¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DB    â”‚     â”‚  Queue  â”‚
â”‚ âœ… ì €ì¥  â”‚     â”‚ âŒ ì‹¤íŒ¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†’ ì£¼ë¬¸ì€ ìˆëŠ”ë° ì´ë²¤íŠ¸ ì—†ìŒ

Case 2: ë©”ì‹œì§€ ë°œí–‰ í›„ DB ë¡¤ë°±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DB    â”‚     â”‚  Queue  â”‚
â”‚ âŒ ë¡¤ë°±  â”‚     â”‚ âœ… ë°œí–‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â†’ ì£¼ë¬¸ì€ ì—†ëŠ”ë° ì´ë²¤íŠ¸ ìˆìŒ
```

### 4.2 í•´ê²°ì±…: Outbox íŒ¨í„´

**í•µì‹¬ ì•„ì´ë””ì–´**: ì´ë²¤íŠ¸ë¥¼ ë©”ì‹œì§€ í ëŒ€ì‹  **ê°™ì€ DBì— ì €ì¥**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í•˜ë‚˜ì˜ DB íŠ¸ëœì­ì…˜                              â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚   orders í…Œì´ë¸”  â”‚     â”‚ outbox_events   â”‚                   â”‚
â”‚   â”‚                 â”‚     â”‚     í…Œì´ë¸”       â”‚                   â”‚
â”‚   â”‚  INSERT ì£¼ë¬¸    â”‚     â”‚  INSERT ì´ë²¤íŠ¸  â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                  â”‚
â”‚            ë‘˜ ë‹¤ ì„±ê³µí•˜ê±°ë‚˜ ë‘˜ ë‹¤ ì‹¤íŒ¨ (ì›ìì„±)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                            (ë³„ë„ í”„ë¡œì„¸ìŠ¤)
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Message Queue     â”‚
                         â”‚   (Kafka ë“±)        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Outbox íŒ¨í„´ì˜ ë³´ì¥

| ë³´ì¥ | ì„¤ëª… |
|------|------|
| **At-least-once** | ì´ë²¤íŠ¸ê°€ ìµœì†Œ í•œ ë²ˆì€ ë°œí–‰ë¨ |
| **ìˆœì„œ ë³´ì¥** | ê°™ì€ aggregateëŠ” ìˆœì„œëŒ€ë¡œ ë°œí–‰ |
| **ì¥ì•  ë³µêµ¬** | ì•± ì¬ì‹œì‘ í›„ PENDING ì´ë²¤íŠ¸ ì¬ë°œí–‰ |

**ì£¼ì˜**: ì¤‘ë³µ ë°œí–‰ ê°€ëŠ¥ â†’ Consumerì—ì„œ ë©±ë“±ì„± í•„ìš”

---

## 5. Outbox íŒ¨í„´ êµ¬í˜„

### 5.1 Outbox í…Œì´ë¸”

```sql
CREATE TABLE outbox_events (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    aggregate_type VARCHAR(100) NOT NULL,   -- "Order"
    aggregate_id VARCHAR(100) NOT NULL,     -- "123"
    event_type VARCHAR(100) NOT NULL,       -- "OrderCreated"
    payload TEXT NOT NULL,                  -- JSON ë°ì´í„°
    status VARCHAR(20) DEFAULT 'PENDING',   -- PENDING/PROCESSED/FAILED
    created_at DATETIME DEFAULT NOW(),
    processed_at DATETIME,
    retry_count INT DEFAULT 0
);
```

### 5.2 íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì´ë²¤íŠ¸ ì €ì¥

```kotlin
@Transactional
fun createOrder(buyerId: Long, req: CreateOrderRequest): OrderResponse {
    // 1. ì£¼ë¬¸ ì €ì¥ (ê°™ì€ íŠ¸ëœì­ì…˜)
    val savedOrder = orderJpaRepository.save(order)

    // 2. Outboxì— ì´ë²¤íŠ¸ ì €ì¥ (ê°™ì€ íŠ¸ëœì­ì…˜)
    outboxEventService.saveEvent(
        aggregateType = "Order",
        aggregateId = savedOrder.id.toString(),
        eventType = "OrderCreated",
        payload = mapOf(
            "orderId" to savedOrder.id,
            "buyerId" to buyerId,
            "sellerIds" to sellerIds.toList(),
            "totalAmount" to savedOrder.totalAmount
        )
    )
    // ì»¤ë°‹ ì‹œ ë‘˜ ë‹¤ ì €ì¥ë˜ê±°ë‚˜ ë‘˜ ë‹¤ ë¡¤ë°±

    return OrderResponse.from(savedOrder)
}
```

### 5.3 ë³„ë„ í”„ë¡œì„¸ìŠ¤ê°€ ë©”ì‹œì§€ íë¡œ ë°œí–‰

```kotlin
// OutboxPublisher.kt
@Component
@Profile("docker", "prod")
class OutboxPublisher(
    private val outboxJpaRepository: OutboxJpaRepository,
    private val kafkaTemplate: KafkaTemplate<String, Any>
) {
    @Scheduled(fixedDelay = 1000)  // 1ì´ˆë§ˆë‹¤
    @Transactional
    fun publishPendingEvents() {
        val pendingEvents = outboxJpaRepository.findRetryableEvents()

        pendingEvents.forEach { event ->
            try {
                val topic = determineTopicForEvent(event.eventType)
                kafkaTemplate.send(topic, event.aggregateId, event.payload)
                event.markAsProcessed()
            } catch (e: Exception) {
                event.markAsFailed(e.message ?: "Unknown error")
            }
            outboxJpaRepository.save(event)
        }
    }

    // 7ì¼ ì§€ë‚œ ì²˜ë¦¬ ì™„ë£Œ ì´ë²¤íŠ¸ ì •ë¦¬
    @Scheduled(cron = "0 0 * * * *")
    fun cleanupProcessedEvents() {
        val cutoff = LocalDateTime.now().minusDays(7)
        outboxJpaRepository.deleteProcessedEventsBefore(PROCESSED, cutoff)
    }
}
```

### 5.4 Outbox ì—”í‹°í‹°

```kotlin
// OutboxEvent.kt
@Entity
@Table(name = "outbox_events")
class OutboxEvent(
    val aggregateType: String,    // "Order"
    val aggregateId: String,      // "123"
    val eventType: String,        // "OrderCreated"
    val payload: String,          // JSON

    var status: OutboxStatus = OutboxStatus.PENDING,
    var retryCount: Int = 0
) {
    fun markAsProcessed() {
        this.status = OutboxStatus.PROCESSED
        this.processedAt = LocalDateTime.now()
    }

    fun markAsFailed(error: String) {
        this.retryCount++
        if (this.retryCount >= MAX_RETRY_COUNT) {
            this.status = OutboxStatus.FAILED
        }
    }
}
```

---

## 6. ì¤‘ë³µ ë°œí–‰ê³¼ ë©±ë“±ì„±

### 6.1 ì¤‘ë³µ ë°œí–‰ì´ ë°œìƒí•˜ëŠ” ì¼€ì´ìŠ¤

Outbox íŒ¨í„´ì€ **At-least-once**ë¥¼ ë³´ì¥í•˜ë¯€ë¡œ ì¤‘ë³µ ë°œí–‰ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Case 1: Kafka ë°œí–‰ ì„±ê³µ, DB ì—…ë°ì´íŠ¸ ì „ ì¥ì• **

```
OutboxPublisher ì‹¤í–‰ íë¦„:

1. PENDING ì´ë²¤íŠ¸ ì¡°íšŒ          âœ…
2. Kafkaë¡œ ë°œí–‰                 âœ… (ë©”ì‹œì§€ ì „ì†¡ë¨)
3. status = PROCESSED ì—…ë°ì´íŠ¸  âŒ (ì„œë²„ í¬ë˜ì‹œ!)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”‚  ì´ ì‹œì ì— ì•±ì´ ì£½ìœ¼ë©´?      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì¬ì‹œì‘ í›„:
- DBì—ëŠ” ì—¬ì „íˆ status = PENDING
- OutboxPublisherê°€ ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ ë°œí–‰
- ConsumerëŠ” ê°™ì€ ë©”ì‹œì§€ë¥¼ 2ë²ˆ ë°›ìŒ
```

**Case 2: ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ**

```
1. Kafkaë¡œ ë°œí–‰ ìš”ì²­            âœ…
2. Kafkaê°€ ë©”ì‹œì§€ ì €ì¥          âœ…
3. ì‘ë‹µ ë°˜í™˜ ì¤‘ ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ  âŒ
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”‚  ProducerëŠ” ì‹¤íŒ¨ë¡œ ì¸ì‹      â”‚
   â”‚  ì‹¤ì œë¡œëŠ” Kafkaì— ì €ì¥ë¨     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4. ì¬ì‹œë„ ë¡œì§ì— ì˜í•´ ë‹¤ì‹œ ë°œí–‰
5. Kafkaì— ê°™ì€ ë©”ì‹œì§€ê°€ 2ê°œ
```

**Case 3: ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì‹œ ì²˜ë¦¬**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Instance A    â”‚     â”‚   Instance B    â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ 1. ì´ë²¤íŠ¸ ì¡°íšŒ   â”‚     â”‚ 1. ì´ë²¤íŠ¸ ì¡°íšŒ   â”‚
â”‚    (id=1, PENDING)    â”‚    (id=1, PENDING)
â”‚                 â”‚     â”‚                 â”‚
â”‚ 2. Kafka ë°œí–‰   â”‚     â”‚ 2. Kafka ë°œí–‰   â”‚
â”‚                 â”‚     â”‚                 â”‚
â”‚ 3. PROCESSED    â”‚     â”‚ 3. PROCESSED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ ê°™ì€ ì´ë²¤íŠ¸ê°€ 2ë²ˆ ë°œí–‰ë¨
```

### 6.2 ì¤‘ë³µ ì²˜ë¦¬ ì „ëµ

**ì „ëµ 1: Consumerì—ì„œ ë©±ë“±ì„± ë³´ì¥ (ê¶Œì¥)**

```kotlin
@Component
class OrderEventConsumer(
    private val processedEventRepository: ProcessedEventRepository,
    private val emailService: EmailService
) {
    @KafkaListener(topics = ["marketplace.order.created"])
    fun handleOrderCreated(payload: Map<String, Any>, ack: Acknowledgment) {
        val eventId = payload["eventId"] as String

        // 1. ì´ë¯¸ ì²˜ë¦¬í•œ ì´ë²¤íŠ¸ì¸ì§€ í™•ì¸
        if (processedEventRepository.existsById(eventId)) {
            log.info("ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸, ìŠ¤í‚µ: $eventId")
            ack.acknowledge()
            return
        }

        // 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
        emailService.sendOrderConfirmation(payload)

        // 3. ì²˜ë¦¬ ì™„ë£Œ ê¸°ë¡
        processedEventRepository.save(ProcessedEvent(eventId))

        ack.acknowledge()
    }
}
```

**ì „ëµ 2: DB ìœ ë‹ˆí¬ ì œì•½ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€**

```kotlin
// ì´ë©”ì¼ ë°œì†¡ ê¸°ë¡ í…Œì´ë¸”
@Entity
@Table(
    uniqueConstraints = [
        UniqueConstraint(columnNames = ["order_id", "email_type"])
    ]
)
class EmailSentRecord(
    val orderId: Long,
    val emailType: String,  // "ORDER_CONFIRMATION"
    val sentAt: LocalDateTime = LocalDateTime.now()
)

// Consumerì—ì„œ ì‚¬ìš©
fun sendOrderConfirmation(orderId: Long) {
    try {
        emailSentRecordRepository.save(
            EmailSentRecord(orderId, "ORDER_CONFIRMATION")
        )
        // ì €ì¥ ì„±ê³µ = ì²« ë²ˆì§¸ ì²˜ë¦¬ â†’ ì´ë©”ì¼ ë°œì†¡
        emailService.send(...)
    } catch (e: DataIntegrityViolationException) {
        // ìœ ë‹ˆí¬ ì œì•½ ìœ„ë°˜ = ì´ë¯¸ ì²˜ë¦¬ë¨ â†’ ìŠ¤í‚µ
        log.info("ì´ë¯¸ ë°œì†¡ëœ ì´ë©”ì¼, ìŠ¤í‚µ: orderId=$orderId")
    }
}
```

**ì „ëµ 3: ë¶„ì‚° ë½ìœ¼ë¡œ ë™ì‹œ ì²˜ë¦¬ ë°©ì§€**

```kotlin
@Component
class OutboxPublisher(
    private val redissonClient: RedissonClient
) {
    @Scheduled(fixedDelay = 1000)
    fun publishPendingEvents() {
        val lock = redissonClient.getLock("outbox-publisher-lock")

        // í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì‹¤í–‰
        if (lock.tryLock(0, 5, TimeUnit.SECONDS)) {
            try {
                doPublish()
            } finally {
                lock.unlock()
            }
        }
    }
}
```

**ì „ëµ 4: SELECT FOR UPDATEë¡œ ë™ì‹œ ì¡°íšŒ ë°©ì§€**

```kotlin
interface OutboxJpaRepository : JpaRepository<OutboxEvent, Long> {

    @Lock(LockModeType.PESSIMISTIC_WRITE)
    @Query("SELECT e FROM OutboxEvent e WHERE e.status = :status ORDER BY e.createdAt")
    fun findPendingEventsWithLock(status: OutboxStatus): List<OutboxEvent>
}
```

### 6.3 ë©±ë“±ì„± ì„¤ê³„ ì›ì¹™

| ì›ì¹™ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **ê³ ìœ  ì‹ë³„ì** | ëª¨ë“  ì´ë²¤íŠ¸ì— unique ID í¬í•¨ | `eventId: UUID` |
| **ì²˜ë¦¬ ê¸°ë¡** | ì²˜ë¦¬í•œ ì´ë²¤íŠ¸ ID ì €ì¥ | `processed_events` í…Œì´ë¸” |
| **ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤** | ìì—° í‚¤ë¡œ ì¤‘ë³µ ì²´í¬ | `orderId + emailType` |
| **ê²°ê³¼ ë™ì¼ì„±** | Në²ˆ ì‹¤í–‰í•´ë„ ê²°ê³¼ ê°™ìŒ | `UPDATE ... SET status = 'SENT'` |

```
ë©±ë“±í•œ ì—°ì‚° ì˜ˆì‹œ:

âœ… ë©±ë“±: UPDATE status = 'SENT' WHERE id = 123
         (ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ê²°ê³¼ ë™ì¼)

âŒ ë¹„ë©±ë“±: INSERT INTO emails (order_id, ...)
          (ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•˜ë©´ ì¤‘ë³µ ë°ì´í„°)

âŒ ë¹„ë©±ë“±: UPDATE point = point + 100
          (ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•˜ë©´ ê³„ì† ì¦ê°€)

âœ… ë©±ë“±: UPDATE point = 1100 WHERE id = 123 AND point = 1000
         (ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ë¡œ ë©±ë“±ì„± í™•ë³´)
```

---

## 7. Kafka ê¸°ë³¸ ê°œë…

### 7.1 Kafka ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Kafka Cluster                             â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Topic: marketplace.order.created            â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â”‚   Partition 0: [msg0] [msg3] [msg6] â”€â”€â”€â–¶ offset         â”‚   â”‚
â”‚   â”‚   Partition 1: [msg1] [msg4] [msg7] â”€â”€â”€â–¶ offset         â”‚   â”‚
â”‚   â”‚   Partition 2: [msg2] [msg5] [msg8] â”€â”€â”€â–¶ offset         â”‚   â”‚
â”‚   â”‚                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í•µì‹¬ ìš©ì–´

| ìš©ì–´ | ì„¤ëª… |
|------|------|
| **Topic** | ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬ (í…Œì´ë¸”ê³¼ ìœ ì‚¬) |
| **Partition** | í† í”½ì„ ë‚˜ëˆˆ ë‹¨ìœ„ (ë³‘ë ¬ ì²˜ë¦¬ìš©) |
| **Offset** | íŒŒí‹°ì…˜ ë‚´ ë©”ì‹œì§€ ìœ„ì¹˜ |
| **Consumer Group** | í•¨ê»˜ ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•˜ëŠ” Consumer ì§‘í•© |

### 7.2 íŒŒí‹°ì…˜ê³¼ ë³‘ë ¬ ì²˜ë¦¬

```
Topic: orders (3 partitions)

[Producer]
    â”‚
    â”œâ”€â”€ key=order-123 â”€â”€â–¶ Partition 0
    â”œâ”€â”€ key=order-456 â”€â”€â–¶ Partition 1
    â””â”€â”€ key=order-789 â”€â”€â–¶ Partition 2

[Consumer Group: email-service]
    â”‚
    â”œâ”€â”€ Consumer 1 â—€â”€â”€ Partition 0
    â”œâ”€â”€ Consumer 2 â—€â”€â”€ Partition 1
    â””â”€â”€ Consumer 3 â—€â”€â”€ Partition 2

â†’ 3ê°œì˜ Consumerê°€ ë³‘ë ¬ë¡œ ì²˜ë¦¬
â†’ ê°™ì€ key(orderId)ëŠ” ê°™ì€ íŒŒí‹°ì…˜ â†’ ìˆœì„œ ë³´ì¥
```

### 7.3 Consumer Group

```
ê°™ì€ ë©”ì‹œì§€ë¥¼ ë‹¤ë¥¸ ìš©ë„ë¡œ ì²˜ë¦¬:

Topic: marketplace.order.created
              â”‚
              â”œâ”€â”€â–¶ Consumer Group: email-service
              â”‚         â””â”€â”€ ì£¼ë¬¸ í™•ì¸ ì´ë©”ì¼ ë°œì†¡
              â”‚
              â”œâ”€â”€â–¶ Consumer Group: notification-service
              â”‚         â””â”€â”€ í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡
              â”‚
              â””â”€â”€â–¶ Consumer Group: analytics-service
                        â””â”€â”€ ì£¼ë¬¸ í†µê³„ ì§‘ê³„

ê° ê·¸ë£¹ì€ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ë°›ìŒ (ë…ë¦½ì  ì²˜ë¦¬)
```

### 7.4 ë©”ì‹œì§€ ë³´ì¡´ ì •ì±… (Retention)

**Kafkaì˜ íŠ¹ì§•: ì†Œë¹„í•´ë„ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì§€ ì•ŠìŒ**

```
ì „í†µì ì¸ ë©”ì‹œì§€ í (RabbitMQ ë“±):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Queue: [msg1] [msg2] [msg3]             â”‚
â”‚              â†“                          â”‚
â”‚        Consumerê°€ msg1 ì†Œë¹„             â”‚
â”‚              â†“                          â”‚
â”‚ Queue: [msg2] [msg3]  â† msg1 ì‚­ì œë¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Kafka:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Topic: [msg1] [msg2] [msg3]             â”‚
â”‚              â†“                          â”‚
â”‚        Consumerê°€ msg1 ì†Œë¹„             â”‚
â”‚              â†“                          â”‚
â”‚ Topic: [msg1] [msg2] [msg3]  â† ê·¸ëŒ€ë¡œ!  â”‚
â”‚         â†‘                               â”‚
â”‚    Consumerì˜ offsetë§Œ ì´ë™ (0 â†’ 1)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ì™œ ì‚­ì œí•˜ì§€ ì•ŠëŠ”ê°€?

| ì´ìœ  | ì„¤ëª… |
|------|------|
| **ë‹¤ì¤‘ Consumer Group** | ê° ê·¸ë£¹ì´ ë…ë¦½ì ìœ¼ë¡œ ê°™ì€ ë©”ì‹œì§€ ì†Œë¹„ |
| **ì¬ì²˜ë¦¬ (Replay)** | offsetì„ ë˜ëŒë ¤ ê³¼ê±° ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ê°€ëŠ¥ |
| **ì¥ì•  ë³µêµ¬** | Consumer ì¬ì‹œì‘ ì‹œ ë†“ì¹œ ë©”ì‹œì§€ ì²˜ë¦¬ |
| **ê°ì‚¬ ë¡œê·¸** | ê³¼ê±° ì´ë²¤íŠ¸ ì¶”ì  ê°€ëŠ¥ |

#### Retention ì„¤ì •

```yaml
# Kafka Topic ì„¤ì • ì˜ˆì‹œ
retention.ms: 604800000     # 7ì¼ (ë°€ë¦¬ì´ˆ)
retention.bytes: -1         # í¬ê¸° ì œí•œ ì—†ìŒ (-1)

# ë˜ëŠ”
retention.hours: 168        # 7ì¼ (ì‹œê°„)
```

#### Consumer Offset ê´€ë¦¬

```
Partition 0: [msg0] [msg1] [msg2] [msg3] [msg4] [msg5]
              offset: 0     1      2      3      4      5

Consumer Group A: offset = 3  (msg0~2 ì²˜ë¦¬ ì™„ë£Œ, msg3ë¶€í„° ì²˜ë¦¬)
Consumer Group B: offset = 1  (msg0 ì²˜ë¦¬ ì™„ë£Œ, msg1ë¶€í„° ì²˜ë¦¬)
Consumer Group C: offset = 5  (ëª¨ë‘ ì²˜ë¦¬ ì™„ë£Œ)

â†’ ê° ê·¸ë£¹ì´ ìì‹ ì˜ ì§„í–‰ ìƒí™©(offset)ì„ ë³„ë„ë¡œ ê´€ë¦¬
â†’ ë©”ì‹œì§€ ìì²´ëŠ” retention ì •ì±…ì— ë”°ë¼ ì‚­ì œ
```

#### ì¬ì²˜ë¦¬ (Replay) í™œìš©

**í™œìš© ì‚¬ë¡€:**
- ë²„ê·¸ ìˆ˜ì • í›„ ê³¼ê±° ë°ì´í„° ì¬ì²˜ë¦¬
- ìƒˆ Consumer Group ì¶”ê°€ ì‹œ ê³¼ê±° ì´ë²¤íŠ¸ ì²˜ë¦¬
- ë°ì´í„° ë¶„ì„ì„ ìœ„í•œ ì´ë²¤íŠ¸ ì¬ì¡°íšŒ

---

## 8. Kafka ì„¤ì •

### 8.1 í”„ë¡œì íŠ¸ì˜ Kafka Config

```kotlin
// KafkaConfig.kt
@Configuration
@Profile("docker", "prod")
class KafkaConfig {

    companion object {
        const val ORDER_CREATED_TOPIC = "marketplace.order.created"
        const val ORDER_STATUS_CHANGED_TOPIC = "marketplace.order.status-changed"
    }

    @Bean
    fun producerFactory(): ProducerFactory<String, Any> {
        return DefaultKafkaProducerFactory(mapOf(
            ProducerConfig.BOOTSTRAP_SERVERS_CONFIG to bootstrapServers,
            ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG to StringSerializer::class.java,
            ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG to JsonSerializer::class.java,
            ProducerConfig.ACKS_CONFIG to "all",        // ëª¨ë“  ë³µì œë³¸ í™•ì¸
            ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG to true  // ì¤‘ë³µ ë°©ì§€
        ))
    }
}
```

### 8.2 Consumer êµ¬í˜„ ì˜ˆì‹œ

```kotlin
@Component
class OrderEventConsumer(
    private val emailService: EmailService
) {
    @KafkaListener(
        topics = ["marketplace.order.created"],
        groupId = "email-service"
    )
    fun handleOrderCreated(
        payload: Map<String, Any>,
        ack: Acknowledgment
    ) {
        val orderId = payload["orderId"] as Long
        val buyerId = payload["buyerId"] as Long

        // ë©±ë“±ì„± ì²´í¬ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
        if (emailService.alreadySent(orderId)) {
            ack.acknowledge()
            return
        }

        emailService.sendOrderConfirmation(orderId, buyerId)
        ack.acknowledge()  // ì²˜ë¦¬ ì™„ë£Œ í›„ ì»¤ë°‹
    }
}
```

---

## 9. ì „ì²´ íë¦„ ìš”ì•½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ì£¼ë¬¸ ìƒì„± ìš”ì²­                                               â”‚
â”‚     POST /api/v1/orders                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. OrderService.createOrder() - í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜                 â”‚
â”‚                                                                  â”‚
â”‚     orders í…Œì´ë¸”          outbox_events í…Œì´ë¸”                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚     â”‚ INSERT ì£¼ë¬¸  â”‚       â”‚ INSERT ì´ë²¤íŠ¸    â”‚                 â”‚
â”‚     â”‚ id=123       â”‚       â”‚ type=OrderCreatedâ”‚                 â”‚
â”‚     â”‚ status=PENDINGâ”‚       â”‚ status=PENDING   â”‚                 â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                  â”‚
â”‚     â†’ ì‘ë‹µ ë°˜í™˜ (ë¹ ë¦„)                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. OutboxPublisher (1ì´ˆë§ˆë‹¤ ì‹¤í–‰)                               â”‚
â”‚                                                                  â”‚
â”‚     outbox_events ì¡°íšŒ (status=PENDING)                         â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚     Kafkaë¡œ ë°œí–‰ â”€â”€â–¶ marketplace.order.created                  â”‚
â”‚              â”‚                                                   â”‚
â”‚              â–¼                                                   â”‚
â”‚     status = PROCESSEDë¡œ ë³€ê²½                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Kafka Consumers (ê°ì ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬)                        â”‚
â”‚                                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚ EmailService    â”‚  â”‚ NotificationSvc â”‚                    â”‚
â”‚     â”‚ ì£¼ë¬¸ í™•ì¸ ë©”ì¼   â”‚  â”‚ í‘¸ì‹œ ì•Œë¦¼       â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. FAQ (ë©´ì ‘ ëŒ€ë¹„)

### Q1. ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•„í‚¤í…ì²˜ì˜ ì¥ë‹¨ì ì€?

**ì¥ì :**
- ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•© (ë””ì»¤í”Œë§)
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•
- ê°œë³„ ì„œë¹„ìŠ¤ ë…ë¦½ì  í™•ì¥ ê°€ëŠ¥
- ì¥ì•  ê²©ë¦¬ (í•œ ì„œë¹„ìŠ¤ ì¥ì• ê°€ ì „íŒŒë˜ì§€ ì•ŠìŒ)

**ë‹¨ì :**
- ë””ë²„ê¹… ì–´ë ¤ì›€ (íë¦„ ì¶”ì ì´ ë³µì¡)
- ìµœì¢… ì¼ê´€ì„± (Eventual Consistency)
- ë©”ì‹œì§€ ìˆœì„œ, ì¤‘ë³µ ì²˜ë¦¬ ê³ ë ¤ í•„ìš”
- ì¸í”„ë¼ ë³µì¡ë„ ì¦ê°€

### Q2. Outbox íŒ¨í„´ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ”?

DB ì €ì¥ê³¼ ë©”ì‹œì§€ ë°œí–‰ì€ ì„œë¡œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ë¼ ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì„±ê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì´ì¤‘ ì“°ê¸° ë¬¸ì œ). Outbox íŒ¨í„´ì€ ì´ë²¤íŠ¸ë¥¼ ê°™ì€ DB íŠ¸ëœì­ì…˜ì— ì €ì¥í•˜ì—¬ ì›ìì„±ì„ ë³´ì¥í•˜ê³ , ë³„ë„ í”„ë¡œì„¸ìŠ¤ê°€ ë‚˜ì¤‘ì— ë©”ì‹œì§€ íë¡œ ë°œí–‰í•©ë‹ˆë‹¤.

### Q3. At-least-once vs At-most-once vs Exactly-once?

| ë³´ì¥ ìˆ˜ì¤€ | ì˜ë¯¸ | êµ¬í˜„ |
|----------|------|------|
| At-most-once | ìµœëŒ€ í•œ ë²ˆ (ìœ ì‹¤ ê°€ëŠ¥) | ì²˜ë¦¬ ì „ ì»¤ë°‹ |
| At-least-once | ìµœì†Œ í•œ ë²ˆ (ì¤‘ë³µ ê°€ëŠ¥) | ì²˜ë¦¬ í›„ ì»¤ë°‹ |
| Exactly-once | ì •í™•íˆ í•œ ë²ˆ | íŠ¸ëœì­ì…˜ + ë©±ë“±ì„± |

ì¼ë°˜ì ìœ¼ë¡œ **At-least-once + Consumer ë©±ë“±ì„±**ì´ í˜„ì‹¤ì ì¸ ì„ íƒì…ë‹ˆë‹¤.

### Q4. Consumer ë©±ë“±ì„±ì€ ì–´ë–»ê²Œ êµ¬í˜„í•˜ë‚˜ìš”?

```kotlin
fun handleEvent(event: OrderCreatedEvent, ack: Acknowledgment) {
    // 1. ì´ë¯¸ ì²˜ë¦¬í–ˆëŠ”ì§€ í™•ì¸
    if (processedEventRepository.exists(event.eventId)) {
        ack.acknowledge()
        return
    }

    // 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
    processOrder(event)

    // 3. ì²˜ë¦¬ ì™„ë£Œ ê¸°ë¡
    processedEventRepository.save(event.eventId)

    ack.acknowledge()
}
```

### Q5. ë©”ì‹œì§€ ìˆœì„œê°€ ì¤‘ìš”í•˜ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?

ê°™ì€ í‚¤(ì˜ˆ: orderId)ë¥¼ ê°€ì§„ ë©”ì‹œì§€ëŠ” ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ê°€ë¯€ë¡œ ìˆœì„œê°€ ë³´ì¥ë©ë‹ˆë‹¤.

```kotlin
// ê°™ì€ ì£¼ë¬¸ì˜ ì´ë²¤íŠ¸ëŠ” ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ
kafkaTemplate.send(topic, orderId.toString(), payload)
```

### Q6. Kafka vs RabbitMQ ì„ íƒ ê¸°ì¤€ì€?

| ê¸°ì¤€ | Kafka | RabbitMQ |
|------|-------|----------|
| ì²˜ë¦¬ëŸ‰ | ë†’ìŒ (ìˆ˜ë°±ë§Œ msg/s) | ì¤‘ê°„ |
| ë©”ì‹œì§€ ë³´ì¡´ | ì˜êµ¬ ì €ì¥ | ì†Œë¹„ í›„ ì‚­ì œ |
| ì¬ì²˜ë¦¬ | ê°€ëŠ¥ (offset ì´ë™) | ì–´ë ¤ì›€ |
| ë¼ìš°íŒ… | ë‹¨ìˆœ | ë³µì¡í•œ ë¼ìš°íŒ… ê°€ëŠ¥ |
| ì‚¬ìš© ì‚¬ë¡€ | ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°, ë¡œê·¸ | ì‘ì—… í, RPC |

---

## 11. í”„ë¡œì íŠ¸ íŒŒì¼ êµ¬ì¡°

```
marketplace/
â”œâ”€â”€ marketplace-domain/
â”‚   â””â”€â”€ src/main/kotlin/.../outbox/
â”‚       â””â”€â”€ OutboxEvent.kt              # Outbox ì—”í‹°í‹°
â”‚
â”œâ”€â”€ marketplace-infra/
â”‚   â””â”€â”€ src/main/kotlin/.../outbox/
â”‚       â””â”€â”€ OutboxJpaRepository.kt      # Repository
â”‚
â”œâ”€â”€ marketplace-api/
â”‚   â””â”€â”€ src/main/kotlin/.../
â”‚       â”œâ”€â”€ config/
â”‚       â”‚   â””â”€â”€ KafkaConfig.kt          # Kafka ì„¤ì •
â”‚       â”œâ”€â”€ outbox/
â”‚       â”‚   â””â”€â”€ OutboxPublisher.kt      # ë°œí–‰ ìŠ¤ì¼€ì¤„ëŸ¬
â”‚       â””â”€â”€ order/
â”‚           â””â”€â”€ OrderService.kt         # ì´ë²¤íŠ¸ ì €ì¥
â”‚
â””â”€â”€ docker-compose.yml                  # Kafka, Zookeeper
```

---

## ì •ë¦¬

### í•µì‹¬ íŒ¨í„´ ë¹„êµ

| íŒ¨í„´ | ëª©ì  | í•µì‹¬ |
|------|------|------|
| **ì´ë²¤íŠ¸ ë“œë¦¬ë¸** | ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•© | Producer â†’ Queue â†’ Consumer |
| **Outbox íŒ¨í„´** | ì´ë²¤íŠ¸ ë°œí–‰ ì‹ ë¢°ì„± | DBì™€ ì´ë²¤íŠ¸ë¥¼ ê°™ì€ íŠ¸ëœì­ì…˜ì— ì €ì¥ |
| **ë©±ë“±ì„±** | ì¤‘ë³µ ë©”ì‹œì§€ ì²˜ë¦¬ | ê°™ì€ ë©”ì‹œì§€ Në²ˆ ì²˜ë¦¬í•´ë„ ê²°ê³¼ ë™ì¼ |

### ë©”ì‹œì§€ ë³´ì¥ ìˆ˜ì¤€

| ë³´ì¥ ìˆ˜ì¤€ | ì˜ë¯¸ | êµ¬í˜„ |
|----------|------|------|
| At-most-once | ìµœëŒ€ í•œ ë²ˆ (ìœ ì‹¤ ê°€ëŠ¥) | ì²˜ë¦¬ ì „ ì»¤ë°‹ |
| At-least-once | ìµœì†Œ í•œ ë²ˆ (ì¤‘ë³µ ê°€ëŠ¥) | ì²˜ë¦¬ í›„ ì»¤ë°‹ |
| Exactly-once | ì •í™•íˆ í•œ ë²ˆ | íŠ¸ëœì­ì…˜ + ë©±ë“±ì„± |

### Quick Checklist

- [ ] ì´ë²¤íŠ¸ë¥¼ DBì™€ ê°™ì€ íŠ¸ëœì­ì…˜ì— ì €ì¥í•˜ëŠ”ê°€? (Outbox íŒ¨í„´)
- [ ] Consumerì—ì„œ ë©±ë“±ì„±ì„ ë³´ì¥í•˜ëŠ”ê°€?
- [ ] ì´ë²¤íŠ¸ IDë¡œ ì¤‘ë³µ ì²˜ë¦¬ë¥¼ ì²´í¬í•˜ëŠ”ê°€?
- [ ] ê°™ì€ í‚¤ì˜ ë©”ì‹œì§€ê°€ ìˆœì„œë¥¼ ë³´ì¥ë°›ëŠ”ê°€? (íŒŒí‹°ì…˜ í‚¤)
- [ ] ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„/DLQ ì „ëµì´ ìˆëŠ”ê°€?
- [ ] ì´ë²¤íŠ¸ê°€ ê³¼ê±°í˜•ìœ¼ë¡œ ëª…ëª…ë˜ì—ˆëŠ”ê°€? (OrderCreated)
- [ ] ì´ë²¤íŠ¸ì— í•„ìš”í•œ ì •ë³´ê°€ í¬í•¨ë˜ì—ˆëŠ”ê°€? (ìê¸° ì™„ê²°ì„±)

---

ë‹¤ìŒ í¸ì—ì„œëŠ” **Resilience íŒ¨í„´ (Circuit Breaker, Rate Limiter)**ì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤.

ğŸ‘‰ [ë‹¤ìŒ: 4í¸ - Resilience íŒ¨í„´](/blog/springboot-practical-guide-4)
